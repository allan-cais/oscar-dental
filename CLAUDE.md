# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Oscar** is a hybrid-intelligence dental practice management platform built by Custom AI Studio (CAIS) for Canopy Dental. It operates as an overlay on existing PMS systems (OpenDental, Eaglesoft, Dentrix), progressively replacing legacy workflows without a rip-and-replace migration. The platform combines workflow automation with clinically grounded AI, targeting measurable operational outcomes across revenue cycle management, scheduling, payments, and reputation.

**Client:** Canopy Dental (John Salter, Greg Elmore)
**Development Team:** Custom AI Studio (Devin Kearns, Allan Crawford, Andrew Lewis)
**Project Start:** January 2026

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | Next.js 16 (App Router), React 19, TypeScript |
| UI | shadcn/ui + Tailwind CSS 4 |
| Backend/DB | Convex (real-time database + serverless functions) |
| Auth | Clerk (org-based multi-tenancy, RBAC, MFA) |
| Integrations | Adapter pattern (Stripe, Twilio, Google Business, OpenAI, Vyne = mocked; PMS = NexHealth real adapter built) |
| PMS Sync | NexHealth Synchronizer API (bidirectional sync: pull cron + webhooks + push) |

## Build & Run Commands

```bash
npm run dev          # Start Next.js dev server (Turbopack)
npm run build        # Production build — ALWAYS run after changes to verify
npm run lint         # ESLint
npx convex dev       # Start Convex dev server (requires real deployment keys)
```

**Current build status:** `npm run build` passes cleanly — 44 routes. All 8 sprints + NexHealth integration (7 slices) + endpoint alignment (8 slices) + real data pipeline (Phases 2-5) + mock data seeding + NexHealth v20240412 migration + Oscar Consult Agent V1 complete.

**Convex deployment:** `honorable-peacock-673` (dev). Run `npx convex dev` to start the Convex dev server. Real credentials are in `.env.local`. The `ConvexClientProvider` detects placeholder keys and shows a setup screen — with real keys it connects to Convex directly.

**Data status:** 31 UI pages wired to live Convex queries (18 from NexHealth sync + 13 from seeded/internal data). Seeded data: 361 records across 15 tables (run via `npx convex run "seedAllMockData:seedAllMockData" '{"orgId":"org_canopy_dev"}'`). Remaining mock-data pages depend on non-NexHealth integrations (Stripe, Twilio, Google, Vyne). See "UI Data Sources" section below for details.

## Repository Structure

```
Oscar/
├── convex/                     # Convex backend (serverless functions + schema)
│   ├── _generated/             # Auto-generated by Convex deployment (api.d.ts, server.d.ts, dataModel.d.ts)
│   ├── lib/                    # Shared helpers
│   │   ├── auth.ts             # getCurrentUser, getOrgId, requireRole
│   │   ├── tenancy.ts          # Multi-tenant query helpers
│   │   ├── audit.ts            # SHA-256 hash chain audit logging
│   │   └── permissions.ts      # Role → action permission map
│   ├── integrations/           # Adapter layer (mock + real)
│   │   ├── pms/                # PMS read/write (interface.ts, mock.ts, nexhealth.ts)
│   │   ├── nexhealth/          # NexHealth API client, types, bidirectional mappers
│   │   ├── clearinghouse/      # Eligibility, claims, ERA
│   │   ├── payments/           # Stripe mock
│   │   ├── sms/                # Twilio mock
│   │   ├── reviews/            # Google Business mock
│   │   ├── ai/                 # OpenAI mock
│   │   └── factory.ts          # Adapter factory (mock/real swap point)
│   ├── patients/               # Patient CRUD + search
│   ├── scheduling/             # Appointment CRUD + status workflow
│   ├── claims/                 # Claims + scrubbing engine
│   ├── eligibility/            # Eligibility verification (real-time + batch)
│   ├── users/                  # User management
│   ├── practices/              # Practice settings
│   ├── providers/              # Provider CRUD
│   ├── operatories/            # Operatory CRUD
│   ├── appointmentTypes/       # Appointment type CRUD
│   ├── denials/                # Denial management + AI categorization + SLA cron
│   ├── appeals/                # Appeal lifecycle + AI letter generation
│   ├── ar/                     # A/R aging report, AI-prioritized worklist, payer behavior
│   ├── predet/                 # Pre-determination workflow
│   ├── quickfill/              # Quick Fill queue + gap-fill + AI suggest patient
│   ├── recall/                 # Recall due list generation + outreach tracking
│   ├── production/             # Production goal tracking (daily/monthly)
│   ├── perfectday/             # Perfect Day schedule templates
│   ├── textToPay/              # Payment link generation + SMS send
│   ├── cardOnFile/             # Card-on-file consent + mock tokenization
│   ├── paymentPlans/           # Payment plan CRUD + installment scheduling
│   ├── collections/            # Collection sequence workflow (Day 0→90)
│   ├── era/                    # ERA-to-claim matching + reconciliation
│   ├── reputation/             # Review dashboard + ingest + response posting
│   ├── reviewRequests/         # Review request lifecycle (create, send, batch, cron)
│   ├── sentiment/              # Sentiment analysis + reviewer-to-patient matching
│   ├── reviewResponses/        # AI response draft generation + approval workflow
│   ├── compliance/             # FTC compliance checks + request filtering
│   ├── tcpa/                   # TCPA consent management + STOP keyword processing
│   ├── notifications/          # Notification CRUD (list, mark read, dismiss, bulk create)
│   ├── health/                 # System/integration health monitoring + alerts
│   ├── feeSchedules/           # Fee schedule CRUD
│   ├── aiActions/              # AI action review queries (listPending, listHistory, getStats) + mutations (approve, reject)
│   ├── audit/                  # Audit log queries/mutations
│   ├── chat/                   # Chat message storage for Oscar Consult Agent
│   ├── nexhealth/              # NexHealth integration (config CRUD, sync actions, webhook processing, push sync, health checks)
│   ├── sync/                   # PMS sync subsystem
│   ├── procedures/             # PMS-synced dental procedures (queries)
│   ├── charges/                # PMS-synced financial charges (queries)
│   ├── pmsPayments/            # PMS-synced payment records (queries) — distinct from Oscar text-to-pay payments
│   ├── adjustments/            # PMS-synced adjustments/write-offs (queries)
│   ├── guarantorBalances/      # PMS-synced patient balances (queries)
│   ├── insuranceBalances/      # PMS-synced insurance balances (queries)
│   ├── treatmentPlans/         # PMS-synced treatment plans (queries)
│   ├── pmsClaims/              # PMS-synced insurance claims (queries) — distinct from Oscar scrubbing claims
│   ├── workingHours/           # PMS-synced provider schedules (queries)
│   ├── insurancePlans/         # PMS-synced insurance plan reference data (queries)
│   ├── tasks/                  # HITL task queries + mutations
│   ├── schema.ts               # Full schema (~42 tables incl. 10 PMS-synced tables, nexhealthConfigs, webhookEvents, agentMessages)
│   ├── seed.ts                 # Original seed data (200 patients, 500 appts, etc.)
│   ├── seedAllMockData.ts      # Mock data seed — 361 records across 15 tables (claims, denials, appeals, AI actions, reviews, etc.)
│   ├── crons.ts                # Scheduled jobs (eligibility, denial SLA, recall, production, payments, collections, reviews, NexHealth sync + health)
│   └── auth.config.ts          # Clerk JWT config
├── agent/                      # Oscar Consult Agent (Claude Agent SDK, ESM)
│   └── src/
│       ├── index.ts            # Agent entry point + team config
│       ├── tools/              # Agent tools (Convex queries, messaging)
│       └── prompts/            # Team-aware system prompts per specialist
├── src/
│   ├── app/
│   │   ├── (auth)/             # Clerk sign-in/sign-up pages
│   │   ├── (dashboard)/        # Main app (protected by auth)
│   │   │   ├── layout.tsx      # Dashboard shell (sidebar + topbar)
│   │   │   ├── dashboard/      # Home dashboard
│   │   │   ├── patients/       # Patient list, hub ([patientId]), match queue
│   │   │   ├── scheduling/     # Calendar view with provider columns
│   │   │   ├── rcm/            # Eligibility, claims (pipeline), denials, A/R
│   │   │   ├── payments/       # Text-to-pay, payment plans, collections, reconciliation
│   │   │   ├── reputation/     # Review monitoring + responses + requests management
│   │   │   ├── tasks/          # HITL task board (SLA timers, role-based, escalation)
│   │   │   ├── ai/             # AI actions dashboard (approve/reject, explainability, performance)
│   │   │   ├── settings/       # Practice, users, providers, operatories, appt types, fee schedules, audit log, TCPA, PMS connection
│   │   │   └── health/         # System health dashboard (integration status incl. NexHealth, token utilization, alerts)
│   │   ├── (onboarding)/       # 9-step onboarding wizard (NexHealth Synchronizer setup, no sidebar layout)
│   │   ├── api/chat/           # Oscar Consult Agent SSE route (GET health check, POST streaming bridge)
│   │   ├── api/webhooks/nexhealth/ # NexHealth webhook handler (HMAC-SHA256 verification, event routing)
│   │   ├── layout.tsx          # Root layout (Convex + Clerk providers)
│   │   ├── page.tsx            # Landing page
│   │   └── globals.css         # Tailwind + shadcn CSS variables
│   ├── components/
│   │   ├── ui/                 # shadcn/ui components (button, card, table, dialog, data-empty-state, etc.)
│   │   ├── chat/               # Oscar Consult Agent chat panel (section badges, agent bubbles, live/demo mode)
│   │   ├── dashboard/          # Sidebar, topbar
│   │   ├── patients/           # Patient header, tabs, schedule-appointment-dialog
│   │   ├── scheduling/         # Calendar view, appointment blocks, dialogs
│   │   └── rcm/                # Eligibility card, claims pipeline, claim detail, COB prompt
│   ├── lib/
│   │   └── utils.ts            # cn() utility
│   └── middleware.ts           # Clerk auth middleware (bypasses with placeholder keys)
├── docs/                       # Planning & requirements documentation
├── .env.local                  # Environment variables (real Convex + NexHealth sandbox + Clerk dev keys)
├── .env.example                # Template for env vars
└── package.json
```

## Key Architecture Decisions

### Convex Deployment
- Convex deployment: `honorable-peacock-673` (dev environment)
- `convex/_generated/` contains real auto-generated types from Convex deployment
- `api.d.ts` defines fully typed API surface — use `api.moduleName.queries.functionName`
- For modules not yet in generated types, use `(api as any).moduleName.queries.functionName`
- `ctx.db.get(id)` returns a union of ALL table document types — use `as any` casts when accessing specific fields
- `tsconfig.json` excludes `convex/**/*` except `convex/_generated/**/*` to avoid type errors from Convex function files

### Multi-Tenancy
- Clerk `org_id` = tenant identifier on every Convex table
- Every query begins with `orgId` index filter
- `getOrgId()` helper extracts from Clerk JWT; throws if missing

### Integration Adapter Pattern
All integrations: `interface.ts` (contract) → `mock.ts` (prototype) → `real.ts` (production). Factory returns mock or real based on config. Business logic never references mocks directly.

**NexHealth (real adapter built):** `convex/integrations/pms/nexhealth.ts` implements `PmsAdapter`. Delegates to `NexHealthApiClient` (`convex/integrations/nexhealth/client.ts`). Factory wired: `if (!config?.useMock && config?.nexhealthConfig)` → returns `NexHealthPmsAdapter`. All PMS types (OpenDental, Eaglesoft, Dentrix) have identical read/write capabilities via NexHealth Synchronizer — no PMS-type-based write gating. HITL fallback is only used when NexHealth config is not configured.

### Audit Logging
- Hash chain: each entry stores `previousHash` + `entryHash`
- Append-only: no update/delete mutations on `auditLogs`
- Every PHI access logs via `createAuditLog()` helper

### HITL Task System
- Generic `tasks` table links to any resource (claim, denial, review, payment, patient, appointment)
- Role-based routing: front_desk, billing, clinical, office_manager
- SLA timers with at-risk/overdue states (default 4-hour SLA for HITL fallback)
- Used as fallback when NexHealth config is not configured for a practice (not based on PMS type)
- `isHitlFallback` flag + `workPacket` JSON for structured work instructions
- Deduplication via `dedupeKey` field with `by_dedupe` index

### Convex Crons (convex/crons.ts)
| Job | Schedule |
|-----|----------|
| Batch eligibility | Daily 5:30 AM CT |
| Denial SLA check | Every 15 min |
| Recall due list generation | Daily 6:00 AM CT |
| Production goals update | Daily 11:00 PM CT |
| Payment plan installment charge | Daily 8:00 AM CT |
| Collection sequence advance | Hourly |
| Fetch Google reviews | Every 15 min |
| Process pending review requests | Every 15 min |
| NexHealth incremental sync | Every 5 min |
| NexHealth health check | Every 5 min |

### NexHealth Synchronizer Integration
Bidirectional sync between Oscar and dental PMS systems via NexHealth REST API (v20240412).

**Architecture:**
```
Oscar (Convex)                    NexHealth API                    PMS
┌─────────────────────┐     ┌──────────────────────┐     ┌──────────────────┐
│ nexhealth/actions.ts │────>│ REST API (v20240412) │<───>│ Synchronizer     │
│ nexhealth/mutations  │<────│ nexhealth.info       │     │ Agent (on-prem)  │
│ Webhook API route    │<────│ Webhooks             │     │ OD/ES/Dentrix    │
└─────────────────────┘     └──────────────────────┘     └──────────────────┘
```

**Data flows:**
- **Pull sync (cron, every 5 min):** `runIncrementalSync` fetches changed patients, appointments, insurance coverages, recalls, procedures, charges, PMS payments from NexHealth, upserts into Convex
- **Full sync (21 steps):** `runFullSync` pulls providers, operatories, patients, appointments, appointment types, fee schedules, recalls, insurance coverages, insurance plans, procedures, charges, payments, adjustments, guarantor balances, insurance balances, treatment plans, claims, working hours
- **Webhook sync (real-time):** `POST /api/webhooks/nexhealth` → HMAC verification → `handleWebhookEvent` action → routes `patient.*`, `appointment.*`, `payment.*`, `insurance.*`, `charge.*` events to upsert mutations
- **Push sync (user-initiated):** Appointment create/update/cancel → `pushAppointment`; Payment posting → `pushPayment`; Write-off → `pushAdjustment`. All PMS types push directly via NexHealth.
- **Health monitoring (every 5 min):** `runHealthCheck` authenticates each config, records health status + alerts

**Key files:**
| File | Purpose |
|------|---------|
| `convex/integrations/nexhealth/client.ts` | HTTP client (auth, retry, pagination, rate-limit) — 84 API methods covering 25+ NexHealth endpoints |
| `convex/integrations/nexhealth/types.ts` | NexHealth API response types — 31+ interfaces for all resource types |
| `convex/integrations/nexhealth/mappers.ts` | Bidirectional type mappers (NexHealth ↔ PMS) — 15+ mapper functions |
| `convex/integrations/pms/interface.ts` | PMS adapter interface with `PmsCapabilities` (no PMS-type write gating) |
| `convex/integrations/pms/nexhealth.ts` | Real PMS adapter implementing `PmsAdapter` — all capabilities enabled |
| `convex/nexhealth/actions.ts` | Sync (full + incremental), push (appointments, payments, adjustments), webhook routing, health checks |
| `convex/nexhealth/mutations.ts` | Config CRUD, 18 upsert mutations (patients, appointments, providers, operatories, appointment types, insurance coverages, recalls, fee schedules, procedures, charges, pmsPayments, adjustments, guarantor balances, insurance balances, treatment plans, pmsClaims, working hours, insurance plans), webhook payment/charge recording, HITL task creation |
| `convex/nexhealth/queries.ts` | Config queries (masked + internal), sync lookups |
| `src/app/api/webhooks/nexhealth/route.ts` | Webhook POST handler (HMAC-SHA256) |
| `src/app/(dashboard)/settings/pms-connection/page.tsx` | PMS connection settings UI |
| `convex/scheduling/mutations.ts` | Push sync triggers via `schedulePushSync` helper |

**PMS capability model:** All PMS types (OpenDental, Eaglesoft, Dentrix) have identical read/write capabilities via NexHealth Synchronizer. No PMS-type-based write guards. `PmsAdapter.getCapabilities()` returns what NexHealth supports, not what the underlying PMS supports.

**Token management:** Re-authenticates per action invocation (no persistent token storage)

**NexHealth API version:** v20240412 — uses `Nex-Api-Version: v20240412` header, cursor-based pagination (`start_cursor`/`end_cursor` + `page_info.has_next_page`), patient phones/address inside `bio` object, appointment boolean flags (`confirmed`, `cancelled`, `checked_out`, `patient_missed`), `NexHealthPrice { amount: string, currency: string }` for financials.

**NexHealth API coverage (84 client methods):**
- Practice: institutions, locations, operatories, providers, patients, procedures, insurance coverages
- Scheduling: appointments, appointment types, available slots, working hours
- Financials: adjustments, fee schedules, payment plans, payment types, balances (guarantor + insurance), charges, claims, insurance plans, payments
- Communication (STUB): clinical notes, documents, patient alerts, recalls, treatment plans
- API management (STUB): sync status, webhook endpoints, subscriptions, onboardings

### Oscar Consult Agent (V1)
AI assistant integrated into the Oscar dashboard for answering questions about practice data.

**Architecture:**
- Claude Agent SDK with 4 specialist agents: Dashboard (team lead), Patients, RCM, Scheduling
- `/api/chat` route: GET health check (detects live vs demo mode), POST SSE streaming bridge
- `agentMessages` Convex table for inter-agent messaging (next-turn inbox model)
- Agent SDK imported dynamically in API route; `serverExternalPackages: ["@anthropic-ai/claude-agent-sdk"]` in next.config.ts
- `agent/**/*` excluded from tsconfig to avoid ESM conflict with Next.js

**Key files:**
| File | Purpose |
|------|---------|
| `agent/src/index.ts` | Agent entry point, team config, specialist routing |
| `agent/src/tools/messaging.ts` | Runtime outbox/inbox pattern (`drainOutbox()`/`setInbox()`) |
| `src/app/api/chat/route.ts` | SSE streaming bridge to Claude Agent SDK |
| `src/components/chat/` | Chat panel UI (section badges, agent bubbles, live/demo mode) |
| `src/lib/chat-context.tsx` | Chat context provider, `teamId` persistence via localStorage |

**Chat UI features:**
- Live mode with section identity badges and agent message bubbles
- Consult persistence via `teamId` shared across sections for same user
- Auto-detects demo vs live mode via GET `/api/chat` health check
- Requires `ANTHROPIC_API_KEY` env var for live mode

### Mock Data Seeding
`convex/seedAllMockData.ts` is an `internalMutation` that populates Oscar-internal workflow tables with realistic data referencing real NexHealth-synced patients/providers.

**Run seedV1:** `npx convex run "seedAllMockData:seedAllMockData" '{"orgId":"org_canopy_dev"}'`
**Run seedV2:** `npx convex run "seedV2:seedV2" '{"orgId":"org_canopy_dev"}'` (1,046 records across 29 table groups)

**Records seeded (361 total):**
| Table | Count | Notes |
|-------|-------|-------|
| users | 8 | admin, office_manager, billing(x2), clinical, front_desk(x2), provider |
| claims | 20 | Mix of draft/submitted/accepted/paid/denied with real CDT codes |
| denials | 20 | 8 statuses, real reason codes, linked to denied claims |
| appeals | 10 | Linked to denials/claims, AI-generated letter content |
| eligibilityResults | 30 | 22 active + 3 inactive + 2 error + 3 pending |
| payments | 15 | text_to_pay type, $25-$500, mix of statuses |
| collectionSequences | 16 | Full step history arrays (Day 0→90) |
| reviews | 15 | Google reviews, ratings weighted 4-5 |
| reviewRequests | 25 | Mix of 6 statuses with aiSatisfactionScore |
| reviewResponses | 15 | AI-generated drafts linked to reviews |
| aiActions | 80 | 8 action types, ~22 pending, confidence scores |
| communicationConsents | 50 | 3 channels, 6 message types, 85% consent rate |
| auditLogs | 30 | Hash chain integrity, 6 action types |
| notifications | 15 | 5 types, 60% read rate |
| tasks | 12 | HITL tasks with SLA deadlines |

**Design:** Deterministic RNG (mulberry32, seed 20260208) for reproducible data. Idempotent — skips if users table already has records for the orgId. References real NexHealth-synced patient/provider IDs.

## Sprint Progress

All 8 core sprints + 7 post-sprint milestones DONE. 44 routes, build clean.

| Phase | What |
|-------|------|
| Sprints 0-8 | Full platform build: schema (~42 tables), auth/RBAC, patient CRUD, scheduling, RCM (eligibility, claims, denials, A/R, appeals), payments (text-to-pay, plans, collections, reconciliation), reputation, onboarding wizard, AI actions dashboard, health monitoring, TCPA compliance, task board, audit log, notifications |
| NH + EA | NexHealth integration: 84 API methods, 31 types, 15+ bidirectional mappers, pull/push/webhook sync, PmsAdapter with 18 capability flags |
| RDP | Real Data Pipeline: 10 PMS-synced tables, 21-step full sync, 7 incremental resource types, 18 UI pages rewired to Convex |
| MDS | Mock Data Seeding: `seedAllMockData.ts` seeds 361 records across 15 tables; `seedV2.ts` seeds 1,046 records across 29 table groups |
| V2M | NexHealth API v20240412 migration: cursor pagination, patient bio restructure, appointment boolean flags, NexHealthPrice types |
| AGT | Oscar Consult Agent V1: Claude Agent SDK, 4 specialist agents, `/api/chat` SSE route, inter-agent messaging, chat UI |
| CWE | Collections Workflow Engine: wired to Convex queries/mutations, fixed `currentStep` day-number bug, patient join, loading states |
| IWP | Internal Pages Wiring: claims actions (View Errors/Check/View Denial), denials actions (Acknowledge/Escalate), dynamic appeal page (full Convex rewrite), static appeal redirect, tasks page cleanup (toast feedback) |
| QA1 | Browser Audit + Display Fixes: fixed React hooks ordering violations (7 pages), patient name resolution (denials, payment-plans, reconciliation), scheduling calendar timezone fix, perfect-day $NaN/undefined, appointment type display, AI actions JSON formatting — 14 files, build clean |

## UI Data Sources

### Pages wired to Convex queries (real NexHealth data + seeded data):
| Page | Convex Query | Data Source |
|------|-------------|-------------|
| `/patients` | `api.patients.queries.list` | NexHealth sync |
| `/scheduling` | `api.providers.queries.list` + `api.scheduling.queries.getByDate` | NexHealth sync |
| `/scheduling/production` | `procedures.queries.list` + `providers.queries.list` | NexHealth sync |
| `/scheduling/quick-fill` | `api.quickfill.queries.list` | NexHealth sync |
| `/scheduling/perfect-day` | `api.operatories.queries.list` + `api.providers.queries.list` + `api.perfectday.queries.getTemplates` | NexHealth sync |
| `/scheduling/recall` | `api.recall.queries.getDueList` | NexHealth sync |
| `/rcm/ar` | `pmsClaims.queries.list` + `pmsPayments.queries.list` | NexHealth sync |
| `/rcm/denials` | `api.denials.queries.list` + `denials.queries.getStats` | Seeded (20 denials) |
| `/rcm/eligibility` (list) | `eligibility.queries.list` | Seeded (30 results) |
| `/ai` | `aiActions.queries.listPending/listHistory/getStats` + `aiActions.mutations.approve/reject` | Seeded (80 actions) |
| `/payments/payment-plans` | `api.paymentPlans.queries.list` | NexHealth sync |
| `/payments/reconciliation` | `pmsPayments.queries.list` + `pmsClaims.queries.list` | NexHealth sync |
| `/dashboard` | Multiple queries (patients, scheduling, procedures, pmsClaims) | NexHealth sync |
| `/health` | `health.queries.getStatus` + `health.queries.getAlerts` | Live system |
| `/settings/providers` | `api.providers.queries.list` | NexHealth sync |
| `/settings/operatories` | `api.operatories.queries.list` | NexHealth sync |
| `/settings/appointment-types` | `api.appointmentTypes.queries.list` | NexHealth sync |
| `/settings/fee-schedules` | `api.feeSchedules.queries.list` | NexHealth sync |
| `/settings/pms-connection` | `api.nexhealth.queries.getConfig` + `sync.queries.listJobs` | Live config |
| `/settings/practice` | `api.practices.queries.list` | NexHealth sync |
| `/settings/audit-log` | `api.audit.queries.list` + `audit.queries.verifyChain` | Seeded (30 entries) |
| `/settings/tcpa` (consents) | `tcpa.queries.listConsents` | Seeded (50 consents) |
| `/patients/match-queue` | `patients.queries.listMatchQueue` | NexHealth sync |
| `/payments/collections` | `collections.queries.list` (with patient join) + `collections.queries.getStats` + `collections.mutations.pause/resume/recordPayment` | Seeded (16 sequences) |
| `/rcm/claims` | `claims.queries.list` + `claims.mutations.*` (scrub, submit) + router navigation for actions | Seeded (20 claims) |
| `/rcm/denials` (actions) | `denials.mutations.acknowledge/escalate` — Acknowledge, Assign, Escalate buttons wired | Seeded (20 denials) |
| `/rcm/denials/[denialId]/appeal` | `denials.queries.getById` + `appeals.queries.getByDenial` + `appeals.mutations.create/generateLetter/updateLetter/submit/recordOutcome` | Seeded (10 appeals) |
| `/rcm/denials/appeal` (static) | Redirect page — directs users to select a denial from the list | N/A |
| `/tasks` | `tasks.queries.list` + `tasks.mutations.assignToMe/escalate/complete` — toast feedback on actions | Seeded (12 tasks) |
| `/settings/users` | `api.users.queries.list` + `api.users.mutations.create/updateRole/deactivate` — toast feedback, skeleton loading | Seeded (8 users) |

### Pages still using inline mock data (external integrations needed):
| Page | Reason |
|------|--------|
| `/rcm/eligibility` (verify card) | `DEMO_RESULT` — requires Vyne clearinghouse for real-time verification |
| `/payments/text-to-pay` | Requires Stripe |
| `/reputation` + `/reputation/requests` | Requires Google Business + Twilio |
| `/settings/tcpa` (STOP events + message types) | Requires Twilio |

### Patient hub tabs (`/patients/[patientId]`) — mixed data sources:
| Tab / Section | Data Source | What's Needed to Wire Up |
|---|---|---|
| Overview | Real (Convex patient + appointments + providers) | — |
| Insurance | Real (Convex patient record) + hardcoded benefits breakdown | Vyne eligibility for real benefits data |
| Appointments | Real (Convex `scheduling.queries.getByPatient`) | — |
| Claims | **Mock** (`demoClaims` array) | `pmsClaims.queries.listByPatient` + Vyne clearinghouse |
| Payments → Balance Summary | Real (Convex patient record balances) | — |
| Payments → Payment History | **Convex** (`pmsPayments.queries.listByPatient`) | NexHealth sandbox returns empty — production will have data |
| Payments → Payment Plan | Static placeholder | `paymentPlans.queries.getByPatient` + Stripe |
| Communications → Consent/Prefs | Real (Convex patient record fields) | — |
| Communications → History | Static empty placeholder | Twilio integration for SMS logs |

## Common Build Issues

- **`ctx.db.get()` union type** — With real Convex types, `ctx.db.get(id)` returns a union of ALL table document types. Use `as any` casts before accessing specific fields.
- **New query modules not in api.d.ts** — After creating new `convex/moduleName/queries.ts` files, the Convex dev server needs to re-generate `api.d.ts`. Until then, use `(api as any).moduleName.queries.list`.
- **Stale `.next` cache** can cause build failures — `rm -rf .next` before rebuild fixes it
- **shadcn toast** component is deprecated → use `sonner` instead
- **Next.js 16** warns about middleware → proxy migration (non-blocking warning)
- **Node modules corruption** after package installs → `rm -rf node_modules && npm install` fixes it
- **Clerk key validation** — Clerk validates publishable key format at build time; provider detects placeholders and shows setup screen instead
- **`collectionSequences.currentStep`** stores DAY NUMBERS (0, 7, 14, 30, 60, 90), NOT array indices. Use `STEP_DAY_TO_INDEX` mapping to convert before indexing into `STEP_CONFIG[]`
- **React hooks ordering** — NEVER wrap `useQuery`/`useMutation` in try-catch blocks; NEVER place early returns (loading/empty guards) before `useMemo`/`useCallback` hooks. All hooks must be called unconditionally at the top of the component. Cast mutations: `useMutation(api.foo.mutations.bar as any) as ((args: any) => Promise<any>) | null`
- **Patient name resolution pattern** — When a page displays patient IDs (from denials, payments, claims, etc.), query `api.patients.queries.list` with `{ limit: 1000, status: "all" }`, build a `Map<string, string>` keyed by both `_id` and `pmsPatientId`, use for display lookups
- **Scheduling calendar timezone** — NexHealth stores appointment dates in UTC; calendar must query a 2-day range (`date` + next day) via `dateEnd` param and filter client-side using `new Date()` local timezone interpretation

## Phase Roadmap

### Phase 1 (Months 1-2): Revenue Engine
- **RCM Core:** Eligibility verification (<30s real-time, batch by 6AM), claims scrubbing (98%+ clean rate), denial management (70%+ appeal success), A/R worklists
- **Smart Scheduling:** Gap-fill, Quick Fill queue, recall management, production goal tracking, Perfect Day templates
- **Text-to-Pay:** Payment links via SMS (Stripe), card-on-file, payment plans, automated collections sequence
- **Reputation Engine:** Automated review requests, Google Business monitoring, AI sentiment analysis, AI response drafts
- **Platform Foundations:** Master Patient Index (MPI), data sync subsystem, audit logging, RBAC, tenant isolation

### Phase 1 Remaining Work (Mock→Convex Wiring + External Integrations)

**Oscar-internal pages — ALL WIRED (IWP milestone):**
| Page | Backend Module | Status |
|------|---------------|--------|
| `/rcm/claims` | `convex/claims/` | DONE — actions wired (View Errors, Check, View Denial) |
| `/tasks` | `convex/tasks/` | DONE — toast feedback, unused state removed |
| `/rcm/denials` (actions) | `convex/denials/` | DONE — Acknowledge, Assign, Escalate wired |
| `/rcm/denials/[denialId]/appeal` | `convex/appeals/` + `convex/denials/` | DONE — full Convex rewrite |
| `/rcm/denials/appeal` (static) | N/A | DONE — replaced with redirect |

**External-integration-dependent pages:**
| Page | Blocked By | Integration |
|------|-----------|-------------|
| `/payments/text-to-pay` | Stripe | Payment link generation + tokenization |
| `/reputation` + `/reputation/requests` | Google Business + Twilio | Review fetch + SMS outreach |
| `/settings/tcpa` (STOP events + message types) | Twilio | SMS webhook processing |
| `/rcm/eligibility` (verify card) | Vyne | Real-time eligibility API |
| `/settings/users` | — | **DONE** — wired to `users.queries.list` + mutations |

**Other next steps:**
- Page-by-page browser audit with real data (31 wired pages)
- Test Oscar Consult Agent with `ANTHROPIC_API_KEY`
- Stripe integration (unblocks text-to-pay, payment plans, card-on-file)

### Phase 2 (Months 3-5): Automated Office Manager
- AI Daily Huddle & KPI Board (delivered by 6AM daily)
- Staff Task Automation (event-driven, role-based routing, SLA tracking)
- HR & Compliance Tracker
- Inventory Tracking (FIFO lot management)
- DSO/Network Views (multi-practice rollup)

### Phase 3 (Future): Clinical Intelligence
- Oscar Scribe (voice-to-documentation)
- FMX Imaging compliance tracking
- Treatment Opportunity Mining

## Third-Party Integrations

| Service | Provider | Phase | Status | Constraints |
|---------|----------|-------|--------|-------------|
| PMS (OpenDental) | via NexHealth Synchronizer | 1 | **BUILT** | Full read/write — 84 API methods, 25+ resource types |
| PMS (Eaglesoft) | via NexHealth Synchronizer | 1 | **BUILT** | Full read/write — identical capabilities via NexHealth |
| PMS (Dentrix) | via NexHealth Synchronizer | 1 | **BUILT** | Full read/write — identical capabilities via NexHealth |
| PMS Sync Layer | NexHealth Synchronizer API | 1 | **BUILT** | Pull cron (5 min), webhooks (real-time), push sync (all PMS types) |
| Payments | Stripe | 1 | Mocked | No built-in HIPAA/PCI compliance layer — must be built |
| Claims | Vyne Dental | 1 | Mocked | $40K/year; claim submission only |
| SMS | Twilio | 1 | Mocked | Cost scales with volume |
| Reviews | Google Business Profile API | 1 | Mocked | Review fetch + response posting |
| LLM | OpenAI | 1-2 | Mocked | AI responses, commentary, denial analysis |
| Computer Vision | Roboflow | 3 | Future | Prototype only — export model restrictions |
| Transcription | Whisper | 3 | Future | Voice-to-text for clinical scribe |

**PMS capability model:** All three PMS systems (OpenDental, Eaglesoft, Dentrix) connect ONLY through NexHealth Synchronizer with identical read/write capabilities. There is no direct PMS connection. If NexHealth exposes an endpoint, it works for all PMS types. HITL fallback tasks are only created when NexHealth config is not available for a practice.

## Compliance Requirements

- **HIPAA:** Required for all PHI handling, audit logging, encrypted storage
- **PCI-DSS:** Required for payment processing (Level 1 via Stripe as service provider; validation costs are client responsibility)
- **TCPA:** SMS opt-out (STOP keyword) honored immediately; consent tracked with timestamp/source; granular opt-out by message type
- **FTC:** No incentives in review requests
- **Audit Logging:** Immutable, tamper-evident logs for all PHI access and patient-impacting actions

## SLA Targets

| Metric | Target |
|--------|--------|
| Clean Claim Rate | >= 98% |
| Days to Submit Claim | < 24 hours |
| A/R (Insurance) | < 30 days |
| Denial Rate | < 5% |
| Appeal Success Rate | >= 70% |
| Eligibility Verification | >= 95% verified |
| Real-time Eligibility | < 30 seconds |
| Review Conversion | >= 15% |
| Google Rating | >= 4.5 stars |
| Review Response Time | < 24 hours |
| Payment Collection | >= 85% |
| Schedule Fill Rate | >= 90% |

## Acceptance Criteria Summary

Phase 1 has ~212 criteria across 28 categories. Key category prefixes:
- `REP.*` — Reputation Engine (12 items, 100% required)
- `ELIG.*` — Eligibility Verification (7 items, 100% required)
- `SCRUB.*` — Claims Scrubbing (7 items, 100% required)
- `DENIAL.*` — Denial Management (6 items, 100% required)
- `AR.*` — A/R Management (5 items, 100% required)
- `QUICKFILL.*` — Quick Fill & Gap Management (6 items, 95% required)
- `RECALL.*` — Recall Management (5 items, 95% required)
- `COLLECT.*` — Collections (7 items, 100% required)
- `TCPA.*` — Communication Compliance (7 items, 100% required)
- `SLA.*` — Performance Targets (12 items, 80% required)
- `AUTH/PWD/AUDIT/HIPAA/PCI.*` — Security & Compliance (32 items, 100% required)
- `PMS.*` — Standalone PMS Requirements (12 items, across Phase 1-2)

## Scope Exclusions

- Full historical data migration (forward-looking sync only)
- On-prem infrastructure management (client/NexHealth responsibility)
- FDA regulatory filings
- Phase 2/3 modules during Phase 1
- Payer-outcome guarantees (CAIS delivers workflow/tracking; payer behavior is outside control)
- PCI annual validation costs (client responsibility)
